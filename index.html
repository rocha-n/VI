<!doctype html>
<html lang="">

<head>
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" href="css/menu.css">
</head>

<body>

<div class="sidenav" id="mySidenav">
    <a class="closebtn" href="javascript:void(0)" onclick="closeNav()">&times;</a>
    <div>
        <div class="radioClass">
            <div>Style de donées</div>
            <input checked="checked" name="pourcentate" type="radio" value="false"/> Quantité <br/>
            <input name="pourcentate" type="radio" value="true"/> Pourcentage
        </div>

        <div class="radioClass" id="nutritionScore" style="display: none">
            <div>Nutrition score</div>
            <select name="nutritionScore">
                <option value="a">A</option>
                <option value="b">B</option>
                <option value="c">C</option>
                <option value="d">D</option>
                <option value="e">E</option>
            </select>
        </div>
        <br/>
    </div>
    <div>
        <div class="radioClass">
            <div> Max de quantité de produit</div>
            <input name="max" type="number" value=""/> <br/>
        </div>
        <br/>
    </div>
    <div>
        <div class="radioClass">
            <div>Style de graphique</div>
            <input checked="checked" name="type" type="radio" value="tree_map"/> Tree map <br/>
            <input name="type" type="radio" value="bar"/> Bar
        </div>
        <br/>
    </div>
    <div id="firstLevel">
        <span onclick="firstLevel()">First Level</span>
        <div class="dropdown-content" id="drop1">
            <a class="level pays" href="#country" id="l1_country">Country</a>
            <a class="level nutriscore" href="#nutriscore" id="l1_nutriscore">Nutriscore</a>
            <a class="level marque" href="#brand" id="l1_brand">Brand</a>
        </div>
    </div>
    <div id="secondLevel">
        <span onclick="secondLevel()">Second Level</span>
        <div class="dropdown-content" id="drop2">
            <a class="level pays" href="#country" id="l2_country">Country</a>
            <a class="level nutriscore" href="#nutriscore" id="l2_nutriscore">Nutriscore</a>
            <a class="level marque" href="#brand" id="l2_brand">Brand</a>
        </div>
    </div>
    <div id="thirdLevel">
        <span>Third Level</span>
        <div class="dropdown-content" id="drop3">
            <a class="level pays" href="#country" id="l3_country">Country</a>
            <a class="level nutriscore" href="#nutriscore" id="l3_nutriscore">Nutriscore</a>
            <a class="level marque" href="#brand" id="l3_brand">Brand</a>
        </div>
        <br/>
    </div>

</div>
<!-- Use any element to open the sidenav -->
<div id="attribution">
    <span onclick="openNav()" style="font-size:30px;cursor:pointer">&#9776; menu</span>
    <span class="attribution">Data used to generate the graph is provided by
            <a href="https://openfoodfacts.org">Open Food Facts</a>
        and is licensed under <a href="https://opendatacommons.org/licenses/odbl/1.0/">ODbL v1.0</a> </span>
</div>

<div id="filter" style="text-align: center"></div>
<div id="viz"></div>

<script src="js/vendor/jquery-3.3.1.min.js"></script>
<script src="js/data.json"></script>
<script src="js/main.js"></script>
<script src="js/menu.js"></script>
<script src="js/vendor/d3.js"></script>
<script src="js/vendor/d3plus.full.js"></script>
<script src="js/vendor/jquery-3.3.1.min.js"></script>
<!--
<script src="https://d3plus.org/js/d3.js"></script>
<script src="https://d3plus.org/js/d3plus.js"></script>-->

<script>
    let dataOriginal = data
    function creatStats(forGroup, parPourcentageNutriscor, nutritionScore, listeCourante, filtres) {
        let max = $("input[name='max']").val() * 1
        let list = []
        let titre = "";
        if (parPourcentageNutriscor) {
            forGroup = forGroup.filter(v => v !== "nutrition");
            list = filtreParQuantiteDeProduit(groupByAndCountNutrition([forGroup[0]], listeCourante), max);
            titre = "Montre le nombre de pourcentage en fonction du nutriscore " + nutritionScore.toUpperCase();
            list = filtrePourLesNutritiomAndComputPourcentage(forGroup, nutritionScore, list);
        } else {
            titre = "Montre le nombre de produit";
            //forGroup = ["pays", "nutrition", "marque"]
            list = filtreParQuantiteDeProduit(groupByAndCountNutrition([forGroup[0]], listeCourante), max);
        }
        $("#viz").empty()
        let height = document.getElementById("attribution").offsetHeight
        let visualization = d3plus.viz()
            .container("#viz")
            .data(list)
            .type($("input[name='type']:checked").val())
            // .type("bar")
            .x(forGroup[0])
            .y("total")
            .id(forGroup)
            .height(window.innerHeight - (height + 20))
            .title(titre)
            //.type({"mode": "slice-dice"})
            .title({
                "sub": "",
                "total": !parPourcentageNutriscor
            })
            .format({
                "number": function (number, params) {
                    var formatted = d3plus.number.format(number, params);
                    if (params.key === "total" && parPourcentageNutriscor) {
                        return number.toFixed(2) + " %";
                    } else {
                        return formatted;
                    }
                }
            })
            .mouse({
                "move": true,                        // key will also take custom function
                "click": function (data1, instance) {
                    if (forGroup.length > 1) {
                        let filtreAttribut = forGroup.shift();
                        filtres.push({attribut: filtreAttribut, value: data1[filtreAttribut]});
                        let text = filtres.reduce((accumulator, currentValue) => {
                            return accumulator + (accumulator.length > 0 ? " > " : "") + "<a class= 'filter' heref='#' id='" + currentValue.attribut + "'>" + currentValue.value.capitalize() + "</a>"
                        }, "");
                        $("#filter").html(text)

                        let list = filtreParAttribut(data, filtres)
                        creatStats(forGroup, parPourcentageNutriscor, nutritionScore, list, filtres)
                    }
                }
            })
            // .depth(3)
            .size("total")
            //.labels({"align": "left", "valign": "top"})
            .draw();
    }

    $(document).ready(function () {
        let forGroupOriginale = ["pays", "nutrition", "marque"]
        let parPourcentageNutriscor = false;

        $('#filter').on('click', '.filter', function (obj) {
            $("#filter").empty()
            parPourcentageNutriscor = $("input[name='pourcentate']:checked").val() === "true";
            let nutritionScore = $("#nutritionScore select").find(":selected").val();
            creatStats(["pays", "nutrition", "marque"], parPourcentageNutriscor, nutritionScore, data, []);
        })

        $("input[name='pourcentate']").click(e => {
            $("#filter").empty()
            parPourcentageNutriscor = $("input[name='pourcentate']:checked").val() === "true";
            let nutritionScore = $("#nutritionScore select").find(":selected").val();
            creatStats(["pays", "nutrition", "marque"], parPourcentageNutriscor, nutritionScore, data, []);
            if (parPourcentageNutriscor) {
                $("#thirdLevel").hide();
                $("#nutritionScore").show();
            } else {
                $("#thirdLevel").show();
                $("#nutritionScore").hide();
            }
        });

        $("#nutritionScore select").on("change", e => {
            let nutritionScore = $(this).find(":selected").val();
            creatStats(["pays", "nutrition", "marque"], parPourcentageNutriscor, nutritionScore, data, []);
        })

        $("input[name='type']").on("change", e => {
            let nutritionScore = $(this).find(":selected").val();
            creatStats(["pays", "nutrition", "marque"], parPourcentageNutriscor, nutritionScore, data, []);
        })

        $("input[name='max']").on("change", e => {
            let nutritionScore = $(this).find(":selected").val();
            creatStats(["pays", "nutrition", "marque"], parPourcentageNutriscor, nutritionScore, data, []);
        })

        let pourcentage = $("input[name='pourcentate']:checked").val() === "true"
        if (pourcentage) {
            $("#thirdLevel").hide();
            $("#nutritionScore").show();
        } else {
            $("#thirdLevel").show();
            $("#nutritionScore").hide();
        }

        // Initialise elements
        var aLevels = $("#firstLevel a")
        firstClass = aLevels.get(0).className.split(" ")[1]
        secondClass = aLevels.get(1).className.split(" ")[1]
        thirdClass = aLevels.get(2).className.split(" ")[1]
        $("#firstLevel span").attr("id", firstClass)
        $("#secondLevel span").attr("id", secondClass)
        $("#thirdLevel span").attr("id", thirdClass)

        console.log("text: " + $(aLevels.get(0)).text())
        $("#firstLevel span").text($(aLevels.get(0)).text())
        $("#secondLevel span").text($(aLevels.get(1)).text())
        $("#thirdLevel span").text($(aLevels.get(2)).text())

        //$("#firstLevel span").text($(e.target).text())


        $("#firstLevel .level").click(e => {
            console.log($(e.target).text());
            console.log(e.target.id);
            console.log(e.target.className);
            $("#firstLevel span").text($(e.target).text())
            var className = e.target.className.split(" ")[1]
            $("#firstLevel span").attr("id", className)

            $("#secondLevel .level").show()
            $("#secondLevel ." + className).hide()
            $("#thirdLevel .level").show()
            $("#thirdLevel ." + className).hide()
        })
        $("#secondLevel .level").click(e => {
            $("#secondLevel span").text($(e.target).text())
            var classNameSecond = e.target.className.split(" ")[1]
            $("#secondLevel span").attr("id", classNameSecond)
            var classNameFirst = $("#firstLevel span").attr("id")

            $("#thirdLevel ." + classNameSecond).hide()
            $("#thirdLevel ." + classNameFirst).hide()
            var aLevels = $("#thirdLevel a")
            aLevels.each((v, a) => {
                var aClass = $(a).attr("class").split(" ")[1]
                if(aClass != classNameSecond && aClass != classNameFirst){
                    $("#thirdLevel span").attr("id", aClass)
                    $("#thirdLevel span").text(aClass)
                }
            })
        })
        creatStats(["pays", "nutrition", "marque"], pourcentage, $("#nutritionScore select").find(":selected").val(), data, []);
    });


</script>
</body>

</html>
